VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
END
Attribute VB_Name = "DieseArbeitsmappe"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Private Sub Workbook_Open()

    Dim backupFolderPath As String
    Dim VBAexportFolderPath As String
    
    ' Ordnerpfade initialisieren
    backupFolderPath = ThisWorkbook.Sheets("Einstellungen").Range("B6").Value
    VBAexportFolderPath = ThisWorkbook.Sheets("Einstellungen").Range("B8").Value

    ' Auto-Backup aktiv?
    If ThisWorkbook.Sheets("Einstellungen").Range("B5").Value = "On" Then

        On Error GoTo ErrorHandler  ' Fehlerbehandlung aktivieren

        Dim backupFilePath As String
        Dim currentDateTime As String

        ' Überprüfen, ob der Backup-Ordner existiert
        If Len(backupFolderPath) = 0 Or Dir(backupFolderPath, vbDirectory) = "" Then
            MsgBox "Der Backup-Ordner '" & backupFolderPath & "' existiert nicht. Bitte einen gültigen Ordnerpfad angeben.", vbCritical
            backupFolderPath = Application.Dialogs(xlDialogOpen).Show
            If backupFolderPath = False Then Exit Sub
        End If
        
        ' Erstelle String für aktuelles Datum und Zeit
        currentDateTime = Format(Now, "yyyymmdd_HHMMSS")
    
        ' Erstelle Namen der Backup-Datei
        backupFilePath = backupFolderPath & "\" & Left(ThisWorkbook.Name, Len(ThisWorkbook.Name) - 5) & "_" & currentDateTime & ".xlsm"
    
        ' Speichere Kopie des Workbooks im Backup-Ordner
        ThisWorkbook.SaveCopyAs backupFilePath
        
        ' Schreibe Zeitstempel des Backups in Zelle A2
        ThisWorkbook.Sheets("Einstellungen").Range("A2").Value = "Letztes Backup: " & Format(Now, "dd.mm.yyyy, HH:MM")
    
        On Error GoTo 0  ' Fehlerbehandlung deaktivieren

    End If

    Exit Sub

ErrorHandler:
    Call LogError(Err.Description, VBAexportFolderPath)
    MsgBox "Ein Fehler ist aufgetreten: " & Err.Description, vbCritical
    On Error GoTo 0

End Sub

Private Sub Workbook_BeforeSave(ByVal SaveAsUI As Boolean, Cancel As Boolean)

    ' VBA-Export aktiv?
    If ThisWorkbook.Sheets("Einstellungen").Range("B7").Value = "On" Then
        
        On Error GoTo ErrorHandler  ' Fehlerbehandlung aktivieren
        
        ' Ordnerpfad initialisieren
        Dim VBAexportFolderPath As String
        VBAexportFolderPath = ThisWorkbook.Sheets("Einstellungen").Range("B8").Value
        
        ' Überprüfen, ob der Export-Ordner existiert
        If Len(VBAexportFolderPath) = 0 Or Dir(VBAexportFolderPath, vbDirectory) = "" Then
            MsgBox "Der Export-Ordner '" & VBAexportFolderPath & "' existiert nicht. Bitte einen gültigen Ordnerpfad angeben.", vbCritical
            VBAexportFolderPath = Application.Dialogs(xlDialogOpen).Show
            If VBAexportFolderPath = False Then Exit Sub
        End If
        
        ' Wenn ein Pfad angegeben ist, den Export durchführen
        Call ExportVBAComponents(VBAexportFolderPath)
        
        On Error GoTo 0  ' Fehlerbehandlung deaktivieren

    End If

    Exit Sub

ErrorHandler:
    Call LogError(Err.Description, VBAexportFolderPath)
    MsgBox "Ein Fehler ist aufgetreten: " & Err.Description, vbCritical
    On Error GoTo 0

End Sub

Public Sub ExportVBAComponents(ByVal VBAexportFolderPath As String)

    Dim component As Object
    Dim componentFilePath As String
    Dim fileExtension As String
    
    ' Durchläuft alle VBA-Komponenten im aktuellen Workbook
    For Each component In ThisWorkbook.VBProject.VBComponents
        ' Bestimmt die Dateierweiterung basierend auf dem Typ der Komponente
        Select Case component.Type
            Case vbext_ct_StdModule: fileExtension = ".bas"
            Case vbext_ct_ClassModule, vbext_ct_Document: fileExtension = ".cls"
            Case vbext_ct_MSForm: fileExtension = ".frm"
            Case Else: fileExtension = ".txt"
        End Select

        ' Setzt den vollständigen Pfad für die zu exportierende Datei
        componentFilePath = VBAexportFolderPath & "\" & component.Name & fileExtension
        
        ' Exportiert die Komponente in eine Datei
        component.Export componentFilePath

    Next

    ' Log-Datei nach Export erstellen
    Call LogError("VBA-Komponenten wurden erfolgreich exportiert.", VBAexportFolderPath)

End Sub

Private Sub LogError(errorMessage As String, VBAexportFolderPath As String)

    Dim filePath As String
    Dim currentDateTime As String
    Dim logsFolderPath As String

    currentDateTime = Format(Now, "yyyymmdd_HHMMSS")

    ' Setze den Pfad für den Logs-Ordner
    logsFolderPath = VBAexportFolderPath & "\Logs"

    ' Überprüfen, ob der Logs-Ordner existiert, ansonsten erstellen
    If Dir(logsFolderPath, vbDirectory) = "" Then
        MkDir logsFolderPath
    End If

    ' Setze den vollständigen Pfad für die Log-Datei
    filePath = logsFolderPath & "\error_" & currentDateTime & ".txt"

    ' Fehler in die Log-Datei schreiben
    Open filePath For Append As #1
    Print #1, Now & ": " & errorMessage
    Close #1

End Sub
